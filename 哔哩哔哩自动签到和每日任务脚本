/**
 * å“”å“©å“”å“©è‡ªåŠ¨ç­¾åˆ°å’Œæ¯æ—¥ä»»åŠ¡è„šæœ¬ - é’é¾™é¢æ¿ç‰ˆ
 * 
 * åŠŸèƒ½ï¼š
 * 1. æ¯æ—¥ç­¾åˆ°
 * 2. è§‚çœ‹è§†é¢‘
 * 3. åˆ†äº«è§†é¢‘
 * 4. æŠ•å¸
 * 5. ç›´æ’­ç­¾åˆ°
 * 6. æ¼«ç”»ç­¾åˆ°
 * 7. é“¶ç“œå­å…‘æ¢ç¡¬å¸
 * 
 * ä½¿ç”¨è¯´æ˜ï¼š
 * 1. åœ¨é’é¾™é¢æ¿ä¸­å®‰è£…ä¾èµ–: axios, crypto-js
 * 2. è®¾ç½®ç¯å¢ƒå˜é‡ï¼šBILIBILI_COOKIE
 * 3. å¯é€‰ç¯å¢ƒå˜é‡ï¼š
 *    - BILIBILI_COIN_NUM: æ¯æ—¥æŠ•å¸æ•°é‡ï¼Œé»˜è®¤5
 *    - BILIBILI_COIN_RESERVE: ä¿ç•™ç¡¬å¸æ•°ï¼Œä½äºæ­¤å€¼ä¸å†æŠ•å¸ï¼Œé»˜è®¤50
 *    - BILIBILI_SELECT_LIKE: æŠ•å¸æ—¶æ˜¯å¦ç‚¹èµï¼Œé»˜è®¤å¦
 *    - BILIBILI_COIN_PRIORITY: æŠ•å¸ç­–ç•¥ 0=çƒ­é—¨è§†é¢‘, 1=å…³æ³¨ç”¨æˆ·ï¼Œé»˜è®¤1
 * 
 * cron: 30 8 * * *
 */

const axios = require('axios');
const CryptoJS = require('crypto-js');

// é…ç½®
const CONFIG = {
    COIN_NUMBER: process.env.BILIBILI_COIN_NUM || 5, // æ¯æ—¥æŠ•å¸æ•°é‡
    COIN_RESERVE: process.env.BILIBILI_COIN_RESERVE || 50, // ä¿ç•™ç¡¬å¸æ•°
    SELECT_LIKE: process.env.BILIBILI_SELECT_LIKE === 'true' ? 1 : 0, // æŠ•å¸æ—¶æ˜¯å¦ç‚¹èµ
    COIN_PRIORITY: process.env.BILIBILI_COIN_PRIORITY || 1, // æŠ•å¸ç­–ç•¥ 0=çƒ­é—¨è§†é¢‘, 1=å…³æ³¨ç”¨æˆ·
    USER_AGENT: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36 Edg/91.0.864.59'
};

// å…¨å±€å˜é‡
const COOKIE = process.env.BILIBILI_COOKIE;
let biliUserInfo = {}; // ç”¨æˆ·ä¿¡æ¯
let totalCoinToday = 0; // ä»Šæ—¥å·²æŠ•å¸æ•°
let needCoins = 0; // ä»Šæ—¥è¿˜éœ€æŠ•å¸æ•°

// å·¥å…·æ–¹æ³•
const $ = {
    log: (msg) => {
        console.log(`\n[${new Date().toLocaleString()}] ${msg}\n`);
    },
    wait: (ms) => new Promise(resolve => setTimeout(resolve, ms)),
    randomNum: (min, max) => Math.floor(Math.random() * (max - min + 1) + min),
    extractCookieValue: (cookie, key) => {
        const match = cookie.match(new RegExp(`${key}=([^;]+)`));
        return match ? match[1] : null;
    }
};

// è¯·æ±‚é…ç½®
const createAxiosInstance = () => {
    const instance = axios.create({
        headers: {
            'Cookie': COOKIE,
            'User-Agent': CONFIG.USER_AGENT,
            'Referer': 'https://www.bilibili.com',
            'Origin': 'https://www.bilibili.com'
        },
        timeout: 10000
    });
    
    // å“åº”æ‹¦æˆªå™¨
    instance.interceptors.response.use(
        response => {
            return response.data;
        },
        error => {
            $.log(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            return Promise.reject(error);
        }
    );
    
    return instance;
};

const api = createAxiosInstance();

// å“”å“©å“”å“©æ¥å£
const biliAPI = {
    // ç”¨æˆ·ä¿¡æ¯
    getUserInfo: () => api.get('https://api.bilibili.com/x/web-interface/nav'),
    // è·å–ç¡¬å¸æ•°é‡
    getCoinBalance: () => api.get('https://account.bilibili.com/site/getCoin'),
    // è·å–ä»Šæ—¥æŠ•å¸è·å¾—çš„ç»éªŒ
    getExpRewardStatus: () => api.get('https://www.bilibili.com/plus/account/exp.php'),
    // ç­¾åˆ°
    doSignIn: () => api.get('https://api.bilibili.com/x/web-interface/nav'),
    // è·å–çƒ­é—¨è§†é¢‘
    getHotVideos: () => api.get('https://api.bilibili.com/x/web-interface/popular?ps=50&pn=1'),
    // è·å–å…³æ³¨ç”¨æˆ·æœ€æ–°è§†é¢‘
    getFollowingVideos: () => api.get('https://api.bilibili.com/x/polymer/web-dynamic/v1/feed/all?type=video&page=1'),
    // è§‚çœ‹è§†é¢‘
    watchVideo: (aid, bvid, duration = 30) => api.post('https://api.bilibili.com/x/click-interface/web/heartbeat', {
        aid: aid,
        bvid: bvid,
        cid: '',
        csrf: $.extractCookieValue(COOKIE, 'bili_jct'),
        played_time: duration,
        realtime: duration,
        start_ts: Math.floor(Date.now() / 1000),
        type: 3,
        dt: 2,
        play_type: 1
    }),
    // åˆ†äº«è§†é¢‘
    shareVideo: (aid, bvid) => api.post('https://api.bilibili.com/x/web-interface/share/add', 
        `aid=${aid}&bvid=${bvid}&csrf=${$.extractCookieValue(COOKIE, 'bili_jct')}`),
    // æŠ•å¸
    addCoin: (aid, bvid, multiply = 1, select_like = CONFIG.SELECT_LIKE) => api.post('https://api.bilibili.com/x/web-interface/coin/add', 
        `aid=${aid}&bvid=${bvid}&multiply=${multiply}&select_like=${select_like}&csrf=${$.extractCookieValue(COOKIE, 'bili_jct')}`),
    // ç›´æ’­ç­¾åˆ°
    doLiveSignIn: () => api.get('https://api.live.bilibili.com/xlive/web-ucenter/v1/sign/DoSign'),
    // æ¼«ç”»ç­¾åˆ°
    doMangaSignIn: () => api.post('https://manga.bilibili.com/twirp/activity.v1.Activity/ClockIn', 
        `csrf=${$.extractCookieValue(COOKIE, 'bili_jct')}`),
    // é“¶ç“œå­å…‘æ¢ç¡¬å¸
    exchangeSilver2Coin: () => api.post('https://api.live.bilibili.com/xlive/revenue/v1/wallet/silver2coin', 
        `csrf=${$.extractCookieValue(COOKIE, 'bili_jct')}&csrf_token=${$.extractCookieValue(COOKIE, 'bili_jct')}`)
};

// ä¸šåŠ¡é€»è¾‘
// 1. è·å–ç”¨æˆ·ä¿¡æ¯
async function getUserInfo() {
    try {
        const res = await biliAPI.getUserInfo();
        if (res.code === 0) {
            biliUserInfo = res.data;
            $.log(`ç™»å½•æˆåŠŸ: ${biliUserInfo.uname}`);
            $.log(`å½“å‰ç­‰çº§: ${biliUserInfo.level_info.current_level}`);
            $.log(`å½“å‰ç»éªŒ: ${biliUserInfo.level_info.current_exp} / ${biliUserInfo.level_info.next_exp}`);
            return true;
        } else {
            $.log(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${res.message}`);
            return false;
        }
    } catch (error) {
        $.log(`è·å–ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸: ${error.message}`);
        return false;
    }
}

// 2. è·å–ç¡¬å¸æ•°é‡
async function getCoinBalance() {
    try {
        const res = await biliAPI.getCoinBalance();
        if (res.code === 0) {
            $.log(`å½“å‰ç¡¬å¸æ•°: ${res.data.money}`);
            return res.data.money;
        } else {
            $.log(`è·å–ç¡¬å¸æ•°é‡å¤±è´¥: ${res.message}`);
            return 0;
        }
    } catch (error) {
        $.log(`è·å–ç¡¬å¸æ•°é‡å¼‚å¸¸: ${error.message}`);
        return 0;
    }
}

// 3. è·å–ä»Šæ—¥æŠ•å¸è·å¾—çš„ç»éªŒ
async function getExpRewardStatus() {
    try {
        const res = await biliAPI.getExpRewardStatus();
        if (res.code === 0) {
            totalCoinToday = res.data.coins_av / 10;
            $.log(`ä»Šæ—¥å·²æŠ•å¸: ${totalCoinToday} ä¸ª`);
            needCoins = Math.max(0, Math.min(CONFIG.COIN_NUMBER, 5) - totalCoinToday);
            $.log(`ä»Šæ—¥è¿˜éœ€æŠ•å¸: ${needCoins} ä¸ª`);
            return needCoins;
        } else {
            $.log(`è·å–æŠ•å¸æƒ…å†µå¤±è´¥: ${res.message}`);
            return 0;
        }
    } catch (error) {
        $.log(`è·å–æŠ•å¸æƒ…å†µå¼‚å¸¸: ${error.message}`);
        return 0;
    }
}

// 4. æ¯æ—¥ç­¾åˆ°
async function doSignIn() {
    try {
        const res = await biliAPI.doSignIn();
        if (res.code === 0 && res.data.isLogin) {
            $.log(`ç­¾åˆ°æˆåŠŸ! æœ¬æœˆç­¾åˆ°æ¬¡æ•°: ${res.data.sign_days}`);
            return true;
        } else {
            $.log(`ç­¾åˆ°å¤±è´¥: ${res.message}`);
            return false;
        }
    } catch (error) {
        $.log(`ç­¾åˆ°å¼‚å¸¸: ${error.message}`);
        return false;
    }
}

// 5. è·å–è§†é¢‘åˆ—è¡¨
async function getVideoList() {
    try {
        let videos = [];
        if (CONFIG.COIN_PRIORITY === '0') {
            // è·å–çƒ­é—¨è§†é¢‘
            const res = await biliAPI.getHotVideos();
            if (res.code === 0) {
                videos = res.data.list.map(item => ({
                    aid: item.aid,
                    bvid: item.bvid,
                    title: item.title,
                    duration: item.duration
                }));
            }
        } else {
            // è·å–å…³æ³¨ç”¨æˆ·è§†é¢‘
            const res = await biliAPI.getFollowingVideos();
            if (res.code === 0) {
                videos = res.data.items
                    .filter(item => item.type === 'DYNAMIC_TYPE_AV')
                    .map(item => ({
                        aid: item.modules.module_dynamic.major.archive.aid,
                        bvid: item.modules.module_dynamic.major.archive.bvid,
                        title: item.modules.module_dynamic.major.archive.title,
                        duration: item.modules.module_dynamic.major.archive.duration
                    }));
            }
        }
        
        if (videos.length === 0) {
            // å¤‡ç”¨ï¼šå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œå°±ä½¿ç”¨çƒ­é—¨è§†é¢‘
            const res = await biliAPI.getHotVideos();
            if (res.code === 0) {
                videos = res.data.list.map(item => ({
                    aid: item.aid,
                    bvid: item.bvid,
                    title: item.title,
                    duration: item.duration
                }));
            }
        }
        
        $.log(`è·å–åˆ° ${videos.length} ä¸ªè§†é¢‘`);
        return videos;
    } catch (error) {
        $.log(`è·å–è§†é¢‘åˆ—è¡¨å¼‚å¸¸: ${error.message}`);
        return [];
    }
}

// 6. è§‚çœ‹è§†é¢‘
async function watchVideo(videoList) {
    if (videoList.length === 0) return false;
    
    try {
        // éšæœºé€‰æ‹©ä¸€ä¸ªè§†é¢‘
        const randomIndex = $.randomNum(0, videoList.length - 1);
        const video = videoList[randomIndex];
        
        $.log(`æ­£åœ¨è§‚çœ‹è§†é¢‘: ${video.title}`);
        const res = await biliAPI.watchVideo(video.aid, video.bvid, 30);
        
        if (res.code === 0) {
            $.log(`è§‚çœ‹è§†é¢‘æˆåŠŸ`);
            return { success: true, video };
        } else {
            $.log(`è§‚çœ‹è§†é¢‘å¤±è´¥: ${res.message}`);
            return { success: false };
        }
    } catch (error) {
        $.log(`è§‚çœ‹è§†é¢‘å¼‚å¸¸: ${error.message}`);
        return { success: false };
    }
}

// 7. åˆ†äº«è§†é¢‘
async function shareVideo(video) {
    if (!video) return false;
    
    try {
        $.log(`æ­£åœ¨åˆ†äº«è§†é¢‘: ${video.title}`);
        const res = await biliAPI.shareVideo(video.aid, video.bvid);
        
        if (res.code === 0) {
            $.log(`åˆ†äº«è§†é¢‘æˆåŠŸ`);
            return true;
        } else {
            $.log(`åˆ†äº«è§†é¢‘å¤±è´¥: ${res.message}`);
            return false;
        }
    } catch (error) {
        $.log(`åˆ†äº«è§†é¢‘å¼‚å¸¸: ${error.message}`);
        return false;
    }
}

// 8. æŠ•å¸
async function addCoins(videoList) {
    if (videoList.length === 0 || needCoins <= 0) return 0;
    
    try {
        let coinBalance = await getCoinBalance();
        if (coinBalance < CONFIG.COIN_RESERVE) {
            $.log(`ç¡¬å¸ä½™é¢ä½äºä¿ç•™å€¼ ${CONFIG.COIN_RESERVE}ï¼Œä¸å†æŠ•å¸`);
            return 0;
        }
        
        const maxCoins = Math.min(needCoins, coinBalance - CONFIG.COIN_RESERVE);
        if (maxCoins <= 0) {
            $.log(`æ²¡æœ‰è¶³å¤Ÿçš„ç¡¬å¸ç”¨äºæŠ•å¸æ“ä½œ`);
            return 0;
        }
        
        $.log(`å¼€å§‹æŠ•å¸ï¼Œè®¡åˆ’æŠ•å¸ ${maxCoins} ä¸ª`);
        let successCount = 0;
        
        // æ‰“ä¹±è§†é¢‘åˆ—è¡¨é¡ºåº
        const shuffledVideos = videoList.sort(() => Math.random() - 0.5);
        
        for (let i = 0; i < shuffledVideos.length && successCount < maxCoins; i++) {
            const video = shuffledVideos[i];
            $.log(`æŠ•å¸è§†é¢‘: ${video.title}`);
            
            const res = await biliAPI.addCoin(video.aid, video.bvid, 1, CONFIG.SELECT_LIKE);
            
            if (res.code === 0) {
                $.log(`æŠ•å¸æˆåŠŸ`);
                successCount++;
                // é˜²æ­¢é¢‘ç¹æ“ä½œ
                await $.wait(2000);
            } else {
                $.log(`æŠ•å¸å¤±è´¥: ${res.message}`);
                await $.wait(1000);
            }
        }
        
        $.log(`æŠ•å¸ä»»åŠ¡å®Œæˆï¼ŒæˆåŠŸæŠ•å¸ ${successCount} ä¸ª`);
        return successCount;
    } catch (error) {
        $.log(`æŠ•å¸ä»»åŠ¡å¼‚å¸¸: ${error.message}`);
        return 0;
    }
}

// 9. ç›´æ’­ç­¾åˆ°
async function doLiveSignIn() {
    try {
        const res = await biliAPI.doLiveSignIn();
        if (res.code === 0) {
            $.log(`ç›´æ’­ç­¾åˆ°æˆåŠŸï¼Œè·å¾— ${res.data.text}`);
            return true;
        } else {
            $.log(`ç›´æ’­ç­¾åˆ°å¤±è´¥: ${res.message}`);
            return false;
        }
    } catch (error) {
        $.log(`ç›´æ’­ç­¾åˆ°å¼‚å¸¸: ${error.message}`);
        return false;
    }
}

// 10. æ¼«ç”»ç­¾åˆ°
async function doMangaSignIn() {
    try {
        const res = await biliAPI.doMangaSignIn();
        if (res.code === 0) {
            $.log(`æ¼«ç”»ç­¾åˆ°æˆåŠŸ`);
            return true;
        } else {
            $.log(`æ¼«ç”»ç­¾åˆ°å¤±è´¥: ${res.message}`);
            return false;
        }
    } catch (error) {
        $.log(`æ¼«ç”»ç­¾åˆ°å¼‚å¸¸: ${error.message}`);
        return false;
    }
}

// 11. é“¶ç“œå­å…‘æ¢ç¡¬å¸
async function exchangeSilver2Coin() {
    try {
        const res = await biliAPI.exchangeSilver2Coin();
        if (res.code === 0) {
            $.log(`é“¶ç“œå­å…‘æ¢æˆåŠŸï¼Œè·å¾— ${res.data.coin} ä¸ªç¡¬å¸`);
            return true;
        } else {
            $.log(`é“¶ç“œå­å…‘æ¢å¤±è´¥: ${res.message}`);
            return false;
        }
    } catch (error) {
        $.log(`é“¶ç“œå­å…‘æ¢å¼‚å¸¸: ${error.message}`);
        return false;
    }
}

// ä¸»å‡½æ•°
async function main() {
    $.log('ğŸ”” å“”å“©å“”å“©è‡ªåŠ¨ä»»åŠ¡å¼€å§‹');
    
    if (!COOKIE) {
        $.log('âš ï¸ æœªè®¾ç½®BILIBILI_COOKIEï¼Œè¯·å…ˆåœ¨ç¯å¢ƒå˜é‡ä¸­é…ç½®');
        return;
    }
    
    // ç™»å½•æ£€æŸ¥
    const isLogin = await getUserInfo();
    if (!isLogin) {
        $.log('âš ï¸ ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥Cookieæ˜¯å¦æœ‰æ•ˆ');
        return;
    }
    
    // è·å–ç»éªŒçŠ¶æ€
    await getExpRewardStatus();
    
    // æ¯æ—¥ä»»åŠ¡
    await doSignIn();
    
    // ç›´æ’­ç­¾åˆ°
    await doLiveSignIn();
    
    // æ¼«ç”»ç­¾åˆ°
    await doMangaSignIn();
    
    // è·å–è§†é¢‘åˆ—è¡¨
    const videoList = await getVideoList();
    
    // è§‚çœ‹è§†é¢‘
    const watchResult = await watchVideo(videoList);
    
    // åˆ†äº«è§†é¢‘
    if (watchResult.success) {
        await shareVideo(watchResult.video);
    }
    
    // æŠ•å¸
    await addCoins(videoList);
    
    // é“¶ç“œå­å…‘æ¢ç¡¬å¸
    await exchangeSilver2Coin();
    
    $.log('ğŸ‰ å“”å“©å“”å“©è‡ªåŠ¨ä»»åŠ¡å®Œæˆ');
}

// æ‰§è¡Œ
main().catch(error => {
    $.log(`âŒ è¿è¡Œå¼‚å¸¸: ${error.message}`);
});
